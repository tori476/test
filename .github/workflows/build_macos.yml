name: Build macOS and Notify Discord

on:
  push:
    branches: [ main ] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å®Ÿè¡Œ
  workflow_dispatch: {} # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

defaults:
  run:
    shell: bash

jobs:
  buildForMacOS:
    name: Build Unity Project on macOS
    runs-on: macos-latest # GitHubãƒ›ã‚¹ãƒ†ãƒƒãƒ‰ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆmacOSï¼‰ã‚’ä½¿ç”¨

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true 
          submodules: recursive

      # ğŸš¨ ã“ã“ã‚’**ã‚ãªãŸã®Unityãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã«åˆã‚ã›ã‚‹ï¼
      - name: Set up Unity Editor
        uses: game-ci/unity-setup@v4
        with:
          unity-version: 2021.3.16f1 # â† **ã“ã“ã‚’ä¿®æ­£**

      # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: Run Unity Build
        run: |
          # ğŸš¨ BuildApp.Buildã¯ã€ã‚ãªãŸãŒAssets/Editorã«ä½œæˆã—ãŸ
          #    ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¯ãƒ©ã‚¹å.ãƒ¡ã‚½ãƒƒãƒ‰åã«åˆã‚ã›ã‚‹
          Unity -batchmode -quit -projectPath . -buildTarget StandaloneOSX -executeMethod BuildApp.Build -logFile - || exit 1

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: App_macOS 
          path: Builds/App/ # ãƒ“ãƒ«ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸå‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã«åˆã‚ã›ã‚‹
          retention-days: 7

      # ----------------------------------------
      # Discordé€šçŸ¥ (æˆåŠŸæ™‚)
      # ----------------------------------------
      - name: Send Success Notification to Discord
        if: success() 
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "âœ… Unity Build Succeeded (macOS)",
                "description": "ãƒªãƒã‚¸ãƒˆãƒª ${{ github.repository }} ã§ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸã€‚",
                "color": 3066993,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'
          
      # ----------------------------------------
      # Discordé€šçŸ¥ (å¤±æ•—æ™‚)
      # ----------------------------------------
      - name: Send Failure Notification to Discord
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "âŒ Unity Build Failed (macOS)",
                "description": "ãƒªãƒã‚¸ãƒˆãƒª ${{ github.repository }} ã§ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                "color": 15158332,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'