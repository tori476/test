name: Build macOS and Notify Discord

on:
  push:
    branches: [ main ] 
  workflow_dispatch: {} 

defaults:
  run:
    shell: bash

jobs:
  buildForMacOS:
    name: Build Unity Project on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true 
          submodules: recursive

      - name: Set up Unity Editor
        # 💡 アクションを修正
        uses: unity-actions/setup-unity@v2
        with:
          # 🚨 プロジェクトのUnityバージョンに合わせる！例: 2022.3.5f1
          unity-version: 6000.2.2f1 # ← ここをあなたの正しいバージョンに修正

      - name: Run Unity Build
        run: |
          # 🚨 BuildApp.Buildは、作成したビルドスクリプトのクラス名.メソッド名に合わせる
          Unity -batchmode -quit -projectPath . -buildTarget StandaloneOSX -executeMethod BuildApp.Build -logFile - || exit 1

      - name: Upload Build Artifact
        # ✅ v4に修正
        uses: actions/upload-artifact@v4
        with:
          name: App_macOS 
          path: Builds/App/ # ビルドメソッドで指定した出力フォルダに合わせる
          retention-days: 7

      - name: Send Success Notification to Discord
        if: success() 
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "✅ Unity Build Succeeded (macOS)",
                "description": "リポジトリ ${{ github.repository }} でビルドが成功しました。",
                "color": 3066993,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'
          
      - name: Send Failure Notification to Discord
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "❌ Unity Build Failed (macOS)",
                "description": "リポジトリ ${{ github.repository }} でビルドが失敗しました。ログを確認してください。",
                "color": 15158332,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'