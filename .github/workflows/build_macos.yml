name: Unity Build and Notify

# このワークフローを 'main' ブランチへのプッシュで実行する
on:
  push:
    branches:
      - main  # mainブランチへのプッシュで実行

# 環境変数（Unityエディタバージョンを設定）
env:
  UNITY_VERSION: 6000.2.2f1 # あなたの指定したバージョン

jobs:
  build_webgl:
    runs-on: ubuntu-latest
    
    steps:
      # 1. リポジトリのチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true # Git LFS を利用している場合、これを有効にする
          
      # 2. Unityライセンスのアクティベート
      - name: Activate Unity License
        # ★ バージョンタグを v3 に修正 ★
        uses: game-ci/unity-actions/activate@v3  
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }} 
          
      # 3. Unity ビルドの実行 (WebGLの例)
      - name: Build project (WebGL)
        # ★ バージョンタグを v3 に修正 ★
        uses: game-ci/unity-actions/builder@v3    
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: WebGL
          # ビルド成果物が出力されるディレクトリ名
          buildsPath: build/WebGL
          
      # 4. ビルド成果物をGitHub ActionsのArtifactsにアップロード
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build-${{ github.sha }}
          path: build/WebGL
          
      # 5. Unityライセンスのディアクティベート（重要）
      - name: Deactivate Unity License
        # ★ バージョンタグを v3 に修正 ★
        uses: game-ci/unity-actions/deactivate@v3 
        if: always() # ビルドが失敗しても実行されるようにする
          
      # 6. Discordへの通知 (成功時)
      - name: Send Discord notification (Success)
        if: success()
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: info
          text: |
            ✅ **Unity ビルド成功!**
            **プラットフォーム:** WebGL
            **ブランチ:** `${{ github.ref_name }}`
            **コミット:** `${{ github.event.head_commit.message }}`
            ビルド成果物はGitHub ActionsのArtifactsタブからダウンロード可能です。
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}

      # 7. Discordへの通知 (失敗時)
      - name: Send Discord notification (Failure)
        if: failure()
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: error
          text: |
            ❌ **Unity ビルド失敗!**
            **ブランチ:** `${{ github.ref_name }}`
            **コミット:** `${{ github.event.head_commit.message