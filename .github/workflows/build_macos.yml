name: Build macOS and Notify Discord

on:
  push:
    branches: [ main ] 
  workflow_dispatch: {} 

defaults:
  run:
    shell: bash

jobs:
  buildForMacOS:
    name: Build Unity Project on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true 
          submodules: recursive

      - name: Set up Unity Editor
        # ğŸ’¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£
        uses: unity-actions/setup-unity@v2
        with:
          # ğŸš¨ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Unityãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹ï¼ä¾‹: 2022.3.5f1
          unity-version: 6000.2.2f1 # â† ã“ã“ã‚’ã‚ãªãŸã®æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿®æ­£

      - name: Run Unity Build
        run: |
          # ğŸš¨ BuildApp.Buildã¯ã€ä½œæˆã—ãŸãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¯ãƒ©ã‚¹å.ãƒ¡ã‚½ãƒƒãƒ‰åã«åˆã‚ã›ã‚‹
          Unity -batchmode -quit -projectPath . -buildTarget StandaloneOSX -executeMethod BuildApp.Build -logFile - || exit 1

      - name: Upload Build Artifact
        # âœ… v4ã«ä¿®æ­£
        uses: actions/upload-artifact@v4
        with:
          name: App_macOS 
          path: Builds/App/ # ãƒ“ãƒ«ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸå‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã«åˆã‚ã›ã‚‹
          retention-days: 7

      - name: Send Success Notification to Discord
        if: success() 
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "âœ… Unity Build Succeeded (macOS)",
                "description": "ãƒªãƒã‚¸ãƒˆãƒª ${{ github.repository }} ã§ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸã€‚",
                "color": 3066993,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'
          
      - name: Send Failure Notification to Discord
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "âŒ Unity Build Failed (macOS)",
                "description": "ãƒªãƒã‚¸ãƒˆãƒª ${{ github.repository }} ã§ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                "color": 15158332,
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
          }'